<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Remoto MAES26</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen pb-20"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect } = React;

        // --- MISMA CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Lista de Máquinas (Misma referencia)
        const MACHINES = [
            { id: 'm35', name: '35' }, { id: 'm39', name: '39' }, { id: 'm40', name: '40' },
            { id: 'm36', name: '36' }, { id: 'm38', name: '38' }, { id: 'm37', name: '37' },
            { id: 'm29', name: '29' }, { id: 'm28', name: '28' }, { id: 'm27', name: '27' },
            { id: 'm33', name: '33' }, { id: 'm1',  name: '01' }, { id: 'm30', name: '30' },
            { id: 'm31', name: '31' }, { id: 'm6',  name: '06' }, { id: 'm32', name: '32' },
            { id: 'm13', name: '13' }, { id: 'm12', name: '12' }, { id: 'm24', name: '24' },
            { id: 'm8',  name: '08' },
        ];

        const RemoteControl = () => {
            const [visibility, setVisibility] = useState({ machines: [] });
            const [navState, setNavState] = useState({ weekOffset: 0 });
            const [connected, setConnected] = useState(false);

            useEffect(() => {
                signInAnonymously(auth).then(() => setConnected(true));

                // 1. Escuchar visibilidad
                const unsubVis = onSnapshot(doc(db, 'settings', 'visibility'), (s) => {
                    if(s.exists()) setVisibility(s.data());
                });
                
                // 2. Escuchar navegación (Control de semana)
                const unsubNav = onSnapshot(doc(db, 'settings', 'navigation'), (s) => {
                    if(s.exists()) setNavState(s.data());
                    else setDoc(doc(db, 'settings', 'navigation'), { weekOffset: 0 }); // Init si no existe
                });

                return () => { unsubVis(); unsubNav(); };
            }, []);

            // --- ACCIONES ---
            const toggleMachine = async (id) => {
                const isHidden = visibility.machines?.includes(id);
                let newMachines = [...(visibility.machines || [])];
                
                if (isHidden) {
                    newMachines = newMachines.filter(m => m !== id); // Mostrar
                } else {
                    newMachines.push(id); // Ocultar
                }
                
                await updateDoc(doc(db, 'settings', 'visibility'), { machines: newMachines });
            };

            const updateWeek = async (delta) => {
                const current = navState.weekOffset || 0;
                let next = delta === 0 ? 0 : current + delta; // 0 = Reset a hoy
                await setDoc(doc(db, 'settings', 'navigation'), { weekOffset: next }, { merge: true });
            };

            return (
                <div className="p-4 max-w-md mx-auto">
                    {/* Header */}
                    <header className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-3">
                            <div className={`w-3 h-3 rounded-full ${connected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                            <h1 className="text-xl font-bold text-slate-100">MANDO MAES26</h1>
                        </div>
                        <i data-lucide="wifi" className="text-slate-500"></i>
                    </header>

                    {/* Control de Navegación (Semana) */}
                    <section className="bg-slate-800 rounded-2xl p-4 mb-6 shadow-lg border border-slate-700">
                        <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Navegación Monitor</h2>
                        <div className="flex gap-2">
                            <button onClick={() => updateWeek(-1)} className="btn-press flex-1 bg-slate-700 hover:bg-slate-600 p-4 rounded-xl flex items-center justify-center">
                                <i data-lucide="arrow-left" className="w-8 h-8"></i>
                            </button>
                            
                            <button onClick={() => updateWeek(0)} className="btn-press flex-1 bg-blue-600 hover:bg-blue-500 p-4 rounded-xl flex flex-col items-center justify-center border-b-4 border-blue-800 active:border-b-0 active:mt-1">
                                <span className="text-xs font-bold uppercase">Esta Semana</span>
                                <span className="text-2xl font-black">HOY</span>
                            </button>

                            <button onClick={() => updateWeek(1)} className="btn-press flex-1 bg-slate-700 hover:bg-slate-600 p-4 rounded-xl flex items-center justify-center">
                                <i data-lucide="arrow-right" className="w-8 h-8"></i>
                            </button>
                        </div>
                        <div className="text-center mt-2 text-xs text-slate-500">
                            Offset actual: {navState.weekOffset > 0 ? '+' : ''}{navState.weekOffset} semanas
                        </div>
                    </section>

                    {/* Control de Visibilidad (Máquinas) */}
                    <section>
                        <div className="flex justify-between items-end mb-3">
                            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest">Visibilidad Máquinas</h2>
                            <span className="text-xs text-slate-600">{MACHINES.length - (visibility.machines?.length || 0)} visibles</span>
                        </div>
                        
                        <div className="grid grid-cols-4 gap-2">
                            {MACHINES.map(m => {
                                const isHidden = visibility.machines?.includes(m.id);
                                return (
                                    <button 
                                        key={m.id}
                                        onClick={() => toggleMachine(m.id)}
                                        className={`btn-press p-2 rounded-lg font-bold text-sm border-b-2 transition-all duration-200
                                            ${isHidden 
                                                ? 'bg-slate-900 text-slate-600 border-slate-800 opacity-50' 
                                                : 'bg-emerald-600 text-white border-emerald-800 shadow-lg shadow-emerald-900/50'
                                            }`}
                                    >
                                        {m.name}
                                    </button>
                                );
                            })}
                        </div>
                    </section>

                    <footer className="mt-8 text-center text-slate-600 text-xs">
                        <p>Toca una máquina para ocultarla/mostrarla en el monitor.</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RemoteControl />);
        lucide.createIcons();
    </script>
</body>
</html>

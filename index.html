<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Inventario - Hilaturas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        /* Fija el encabezado de la tabla para que sea visible al hacer scroll */
        .inventory-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Fija los encabezados de grupo */
        .group-header-row {
             position: sticky;
             top: 48px; /* Altura del thead */
             z-index: 9;
        }
        /* Estilo para el modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const Icon = ({ name, size = 18 }) => <i data-lucide={name} style={{ width: size, height: size }}></i>;

        // =================================================================
        // COMPONENTE 1: MODAL DE RECEPCIÓN DE STOCK (ENTRADA)
        // (Sin cambios, se mantiene el código original)
        // =================================================================
        const ReceptionModal = ({ items, onClose, onUpdate }) => {
            const [selectedItem, setSelectedItem] = useState('');
            const [kilosReceived, setKilosReceived] = useState('');
            const [note, setNote] = useState('');
            const [error, setError] = useState(null);

            const materialOptions = items.map(i => ({ value: i.material, id: i.id, stock: i.stock, hex: i.hex, color: i.color }));

            const handleSubmit = async () => {
                const kilos = parseFloat(kilosReceived);
                if (!selectedItem || isNaN(kilos) || kilos <= 0) {
                    setError("Seleccione un material e ingrese una cantidad válida (mayor a 0).");
                    return;
                }
                
                const itemToUpdate = items.find(i => i.material === selectedItem);
                if (!itemToUpdate) {
                    setError("Material no encontrado.");
                    return;
                }

                try {
                    // 1. Calcular el nuevo stock
                    const newStock = (parseFloat(itemToUpdate.stock) || 0) + kilos;

                    // 2. Actualizar el inventario principal
                    const updatedInventoryList = items.map(i => 
                        i.id === itemToUpdate.id 
                        ? { ...i, stock: newStock.toFixed(2) } // Actualiza el stock
                        : i
                    );

                    await db.collection('inventory').doc('main').set({ items: updatedInventoryList });
                    
                    // 3. Registrar el movimiento de entrada (LOG)
                    await db.collection('inventory_movements').add({
                        materialId: itemToUpdate.id,
                        materialName: itemToUpdate.material,
                        color: itemToUpdate.color || '',
                        hex: itemToUpdate.hex || '',
                        type: "ENTRADA",
                        quantityKg: kilos,
                        currentStock: newStock.toFixed(2),
                        date: new Date().toISOString().split('T')[0],
                        timestamp: Date.now(),
                        note: note || 'Recepción de stock'
                    });

                    onUpdate(); // Notificar a App que se actualizó
                    onClose();
                    alert(`¡Éxito! Se sumaron ${kilos} Kg a ${selectedItem}.`);

                } catch (e) {
                    console.error("Error al registrar entrada:", e);
                    setError("Error al guardar en la base de datos.");
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
                        <h3 className="text-xl font-bold mb-4 text-green-700 flex items-center gap-2 border-b pb-2">
                            <Icon name="package-plus"/> Recepción de Stock (Entrada)
                        </h3>
                        {error && <div className="bg-red-100 text-red-700 p-2 rounded text-xs mb-3 font-bold">{error}</div>}
                        
                        <div className="mb-4">
                            <label className="block text-xs font-bold mb-1">Material</label>
                            <select 
                                className="w-full border p-2 rounded font-bold" 
                                value={selectedItem} 
                                onChange={e => { setSelectedItem(e.target.value); setError(null); }}
                            >
                                <option value="">Seleccione Material...</option>
                                {materialOptions.map(m => (
                                    <option key={m.id} value={m.value}>{m.value} - {m.color} (Stock: {m.stock} Kg)</option>
                                ))}
                            </select>
                        </div>
                        <div className="mb-4">
                            <label className="block text-xs font-bold mb-1">Kilos Recibidos (a sumar)</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                placeholder="Ej: 50.00" 
                                className="w-full border-2 border-green-300 p-2 rounded font-black text-xl text-green-700" 
                                value={kilosReceived} 
                                onChange={e => setKilosReceived(e.target.value)} 
                            />
                        </div>
                        <div className="mb-6">
                            <label className="block text-xs font-bold mb-1">Nota / Proveedor</label>
                            <input 
                                type="text" 
                                placeholder="Ej: Recibido de Proveedor X" 
                                className="w-full border p-2 rounded text-sm" 
                                value={note} 
                                onChange={e => setNote(e.target.value)} 
                            />
                        </div>
                        
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 bg-slate-200 rounded font-bold text-sm">Cancelar</button>
                            <button onClick={handleSubmit} className="px-4 py-2 bg-green-600 text-white rounded font-bold text-sm flex items-center gap-1">
                                <Icon name="check"/> Confirmar Recepción
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================
        // COMPONENTE 2: MODAL DE REPORTE DE MOVIMIENTOS
        // (Sin cambios, se mantiene el código original)
        // =================================================================
        const ReportModal = ({ onClose }) => {
            const [movements, setMovements] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchMovements = async () => {
                    try {
                        const snapshot = await db.collection('inventory_movements').orderBy('timestamp', 'desc').limit(200).get();
                        setMovements(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                        setTimeout(() => lucide.createIcons(), 100);
                    } catch (e) {
                        console.error("Error fetching movements:", e);
                        setLoading(false);
                    }
                };
                fetchMovements();
            }, []);
            
            useEffect(() => { lucide.createIcons(); }, [movements]);

            const formatDate = (dateString) => new Date(dateString).toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });

            return (
                <div className="modal-overlay">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <h3 className="text-xl font-bold mb-4 text-slate-800 flex items-center justify-between border-b pb-2 shrink-0">
                            <div className="flex items-center gap-2"><Icon name="bar-chart-3"/> Informe de Movimientos de Inventario</div>
                            <button onClick={onClose} className="text-red-500 font-bold text-sm flex items-center gap-1 hover:bg-red-50 p-1 rounded"><Icon name="x"/> CERRAR</button>
                        </h3>
                        
                        {loading ? (
                            <div className="text-center py-10 text-slate-500">Cargando movimientos...</div>
                        ) : (
                            <div className="overflow-y-auto flex-grow">
                                <table className="w-full text-xs text-left">
                                    <thead className="sticky top-0 bg-slate-100 border-b">
                                        <tr>
                                            <th className="p-2 w-20">Fecha</th>
                                            <th className="p-2 w-16 text-center">Tipo</th>
                                            <th className="p-2">Material</th>
                                            <th className="p-2 w-20 text-right">Cantidad (Kg)</th>
                                            <th className="p-2 w-20 text-center">Stock Final</th>
                                            <th className="p-2">Detalle / Partida</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {movements.map(m => (
                                            <tr key={m.id} className={`border-b ${m.type === 'ENTRADA' ? 'bg-green-50' : 'bg-red-50'}`}>
                                                <td className="p-2 font-mono">{formatDate(m.date)}</td>
                                                <td className="p-2 text-center font-bold">
                                                    <span className={`px-2 py-0.5 rounded-full text-[10px] ${m.type === 'ENTRADA' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                                        {m.type}
                                                    </span>
                                                </td>
                                                <td className="p-2 font-bold flex items-center gap-2">
                                                    <div 
                                                        className="w-4 h-4 rounded-full shadow-sm border border-slate-200 shrink-0" 
                                                        style={{ backgroundColor: m.hex || '#eee' }}
                                                    ></div>
                                                    {m.materialName} ({m.color})
                                                </td>
                                                <td className="p-2 text-right font-black">{parseFloat(m.quantityKg).toFixed(2)}</td>
                                                <td className="p-2 text-center text-xs font-mono">{parseFloat(m.currentStock).toFixed(2)}</td>
                                                <td className="p-2 text-[10px] text-slate-600">{m.note || m.orderId || 'N/A'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {movements.length === 0 && <div className="text-center py-4 text-slate-400">No hay movimientos registrados.</div>}
                            </div>
                        )}
                        
                    </div>
                </div>
            );
        };

        // =================================================================
        // COMPONENTE NUEVO: TARJETA DE ITEM EN VISTA MOSAICO (GRID)
        // =================================================================
        const GridItemCard = ({ item, startEdit, handleDelete }) => {
            const stockFloat = parseFloat(item.stock) || 0;
            const isLow = stockFloat > 0 && stockFloat < 10;
            const isZero = stockFloat === 0;

            return (
                <div className="bg-white border rounded-lg shadow-md p-4 flex flex-col justify-between hover:shadow-lg transition">
                    <div>
                        <div 
                            className="w-full h-10 rounded-t-lg mb-2 shadow-inner border border-slate-200" 
                            style={{ backgroundColor: item.hex || '#eee' }}
                            title={`Código HEX: ${item.hex}`}
                        ></div>
                        <div className="font-bold text-lg text-slate-800 truncate">{item.material}</div>
                        <div className="text-sm text-slate-600 font-medium mb-2">{item.color}</div>
                        
                        <div className="text-xs text-slate-500 mt-2">
                            {item.calibre && <p><span className="font-bold">Calibre:</span> {item.calibre}</p>}
                            {item.estiraje && <p><span className="font-bold">Estiraje:</span> {item.estiraje}</p>}
                            {item.proveedor && <p className="text-[10px] truncate"><span className="font-bold">Prov:</span> {item.proveedor}</p>}
                        </div>
                    </div>

                    <div className="mt-4 pt-3 border-t">
                        <div className="text-center mb-3">
                            <span className={`inline-block px-3 py-1 rounded font-black text-xl 
                                ${isZero ? 'bg-slate-200 text-slate-600' : isLow ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}
                            `}>
                                {isZero ? '0.00' : stockFloat.toFixed(2)} Kg
                            </span>
                            {isZero && <div className="text-[9px] text-slate-500 font-bold mt-1">SIN EXISTENCIA</div>}
                            {isLow && <div className="text-[9px] text-red-500 font-bold mt-1">STOCK BAJO</div>}
                        </div>
                        
                        <div className="flex gap-2 justify-center">
                            <button onClick={() => startEdit(item)} className="p-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded border border-blue-200" title="Editar detalles"><Icon name="pencil" size={16}/></button>
                            <button onClick={() => handleDelete(item.id)} className="p-2 bg-red-50 text-red-600 hover:bg-red-100 rounded border border-red-200" title="Eliminar"><Icon name="trash-2" size={16}/></button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // =================================================================
        // COMPONENTE PRINCIPAL DE INVENTARIO
        // =================================================================
        const InventoryApp = () => {
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            
            const [newItem, setNewItem] = useState({ material: '', color: '', hex: '#000000', calibre: '', estiraje: '', stock: '', proveedor: '', group: '' });
            const [isEditing, setIsEditing] = useState(null);
            
            // ESTADOS MODIFICADOS: Colapsado y Vista (list/grid) por grupo
            const [collapsedGroups, setCollapsedGroups] = useState({});
            const [groupViews, setGroupViews] = useState({}); // Nuevo estado: 'list' o 'grid'
            
            // ESTADOS PARA MODALES
            const [showReceptionModal, setShowReceptionModal] = useState(false);
            const [showReportModal, setShowReportModal] = useState(false);


            // Cargar Inventario
            const fetchInventory = () => {
                 db.collection('inventory').doc('main').get().then(doc => {
                    if (doc.exists) {
                        setItems(doc.data().items || []);
                    }
                    setLoading(false);
                    setTimeout(() => lucide.createIcons(), 500);
                });
            }
            useEffect(() => {
                const unsubscribe = db.collection('inventory').doc('main').onSnapshot(doc => {
                    if (doc.exists) {
                        setItems(doc.data().items || []);
                    }
                    setLoading(false);
                    setTimeout(() => lucide.createIcons(), 500);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => lucide.createIcons(), [items]);

            // =============================================================
            // LÓGICA AGREGADA: CÁLCULO DE LISTA ÚNICA DE PROVEEDORES
            // =============================================================
            const supplierOptions = useMemo(() => {
                const suppliers = new Set();
                items.forEach(item => {
                    if (item.proveedor && item.proveedor.trim() !== '') {
                        suppliers.add(item.proveedor.toUpperCase().trim());
                    }
                });
                return Array.from(suppliers).sort();
            }, [items]);
            
            const toggleGroup = (groupName) => {
                setCollapsedGroups(prev => ({
                    ...prev,
                    [groupName]: !prev[groupName]
                }));
            };
            
            // LÓGICA AGREGADA: CAMBIAR VISTA POR GRUPO
            const toggleGroupView = (groupName) => {
                setGroupViews(prev => ({
                    ...prev,
                    [groupName]: prev[groupName] === 'grid' ? 'list' : 'grid'
                }));
            };

            const groupedItems = useMemo(() => {
                const sortedItems = [...items].sort((a, b) => {
                    const groupA = (a.group || 'SIN GRUPO').toUpperCase();
                    const groupB = (b.group || 'SIN GRUPO').toUpperCase();
                    if (groupA < groupB) return -1;
                    if (groupA > groupB) return 1;
                    
                    if (a.material < b.material) return -1;
                    if (a.material > b.material) return 1;
                    return 0;
                });

                return sortedItems.reduce((acc, item) => {
                    const groupName = item.group || 'SIN GRUPO';
                    if (!acc[groupName]) {
                        acc[groupName] = [];
                    }
                    acc[groupName].push(item);
                    return acc;
                }, {});
            }, [items]);


            const handleSave = async () => {
                if (!newItem.material) return alert("El nombre del material es obligatorio");
                
                let updatedList;
                const stockValue = newItem.stock === '' || newItem.stock === null ? 0 : parseFloat(newItem.stock);

                const payload = {
                    ...newItem,
                    id: isEditing ? newItem.id : Date.now(),
                    stock: stockValue.toFixed(2),
                    hex: newItem.hex || '#000000',
                    group: newItem.group.toUpperCase() || 'SIN GRUPO',
                    updatedAt: new Date().toISOString()
                };

                if (isEditing) {
                    updatedList = items.map(i => i.id === payload.id ? payload : i);
                } else {
                    updatedList = [...items, payload];
                }

                await db.collection('inventory').doc('main').set({ items: updatedList });
                setNewItem({ material: '', color: '', hex: '#000000', calibre: '', estiraje: '', stock: '', proveedor: '', group: '' });
                setIsEditing(null);
            };

            const handleDelete = async (id) => {
                if (window.confirm("¿Eliminar esta hilatura?")) {
                    const updatedList = items.filter(i => i.id !== id);
                    await db.collection('inventory').doc('main').set({ items: updatedList });
                }
            };

            const startEdit = (item) => {
                setNewItem(item);
                setIsEditing(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8"> {/* CAMBIO: max-w-7xl para vista de escritorio */}
                    {showReceptionModal && <ReceptionModal items={items} onClose={() => setShowReceptionModal(false)} onUpdate={fetchInventory} />}
                    {showReportModal && <ReportModal onClose={() => setShowReportModal(false)} />}

                    <header className="mb-8 border-b pb-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-3xl font-black text-slate-800 flex gap-2 items-center">
                                <Icon name="package-search" size={32}/> INVENTARIO HILATURAS
                            </h1>
                            <p className="text-slate-500">Gestión de almacén de materia prima</p>
                        </div>
                        <div className="text-right flex flex-col gap-2">
                            <div className="text-xs font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full">CONECTADO A DB</div>
                            <button 
                                onClick={() => setShowReceptionModal(true)} 
                                className="bg-yellow-600 text-white px-3 py-1 rounded font-bold text-xs flex items-center justify-center gap-1 hover:bg-yellow-700 shadow"
                            >
                                <Icon name="archive-box"/> RECIBIR STOCK (ENTRADA)
                            </button>
                            <button 
                                onClick={() => setShowReportModal(true)} 
                                className="bg-slate-700 text-white px-3 py-1 rounded font-bold text-xs flex items-center justify-center gap-1 hover:bg-slate-800 shadow"
                            >
                                <Icon name="file-text"/> SOLICITAR INFORME
                            </button>
                        </div>
                    </header>

                    {/* FORMULARIO */}
                    <div className="bg-white p-6 rounded-lg shadow-lg border border-slate-200 mb-8">
                        <h2 className="font-bold text-lg mb-4 flex gap-2 items-center text-indigo-700">
                            <Icon name={isEditing ? "edit" : "plus-circle"}/> 
                            {isEditing ? "Editar Hilatura" : "Agregar Nueva Hilatura"}
                        </h2>
                        {/* El formulario ya utiliza una cuadrícula (grid) que se adapta bien a vista de escritorio (md:grid-cols-12) */}
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                            
                            {/* CAMPO GRUPO */}
                            <div className="md:col-span-3">
                                <label className="block text-xs font-bold mb-1 text-indigo-700">GRUPO / CATEGORÍA</label>
                                <input 
                                    list="groups" 
                                    placeholder="Ej. NYLON" 
                                    className="w-full border-2 border-indigo-300 p-2 rounded uppercase font-bold text-indigo-700" 
                                    value={newItem.group} 
                                    onChange={e => setNewItem({...newItem, group: e.target.value.toUpperCase()})} 
                                />
                                <datalist id="groups">
                                    <option value="NYLON" />
                                    <option value="POLIESTER SPUN" />
                                    <option value="POLIESTER SANTONI" />
                                    <option value="ALGODÓN" />
                                    <option value="OTRO" />
                                </datalist>
                            </div>

                            <div className="md:col-span-3">
                                <label className="block text-xs font-bold mb-1">MATERIAL / NOMBRE <span className="text-red-500">*</span></label>
                                <input placeholder="Ej. NYLON 40/2" className="w-full border-2 border-slate-300 p-2 rounded uppercase font-bold" value={newItem.material} onChange={e => setNewItem({...newItem, material: e.target.value.toUpperCase()})} />
                            </div>
                            
                            <div className="md:col-span-3">
                                <label className="block text-xs font-bold mb-1">NOMBRE COLOR</label>
                                <input placeholder="Ej. ROJO FUEGO" className="w-full border p-2 rounded uppercase mb-2" value={newItem.color} onChange={e => setNewItem({...newItem, color: e.target.value.toUpperCase()})} />
                            </div>
                            <div className="md:col-span-3">
                                <label className="block text-xs font-bold mb-1">COLOR (HEX)</label>
                                <div className="flex items-center gap-1">
                                    <input 
                                        type="color" 
                                        className="h-10 w-12 p-0 border-0 rounded cursor-pointer shrink-0"
                                        value={newItem.hex || '#000000'}
                                        onChange={e => setNewItem({...newItem, hex: e.target.value})} 
                                    />
                                    <input 
                                        type="text" 
                                        placeholder="#000000" 
                                        className="w-full border p-2 rounded font-mono text-xs uppercase"
                                        value={newItem.hex || ''}
                                        onChange={e => setNewItem({...newItem, hex: e.target.value})} 
                                    />
                                </div>
                            </div>
                            <div className="md:col-span-4">
                                <label className="block text-xs font-bold mb-1 text-green-700">STOCK INICIAL (KG)</label>
                                <input type="number" step="0.01" placeholder="0.00 (Opcional)" className="w-full border-2 border-green-200 bg-green-50 p-2 rounded font-black text-xl text-green-800" value={newItem.stock} onChange={e => setNewItem({...newItem, stock: e.target.value})} />
                            </div>
                            <div className="md:col-span-4">
                                <label className="block text-xs font-bold mb-1">CALIBRE</label>
                                <input placeholder="Ej. 150/48" className="w-full border p-2 rounded" value={newItem.calibre} onChange={e => setNewItem({...newItem, calibre: e.target.value})} />
                            </div>
                            <div className="md:col-span-4">
                                <label className="block text-xs font-bold mb-1">ESTIRAJE / TÍTULO</label>
                                <input placeholder="Opcional" className="w-full border p-2 rounded" value={newItem.estiraje} onChange={e => setNewItem({...newItem, estiraje: e.target.value})} />
                            </div>
                            
                            {/* ============================================================= */}
                            {/* MODIFICACIÓN: CAMPO PROVEEDOR CON AUTOCOMPLETADO (DATALIST) */}
                            {/* ============================================================= */}
                            <div className="md:col-span-4">
                                <label className="block text-xs font-bold mb-1">PROVEEDOR</label>
                                <input 
                                    list="suppliers" 
                                    placeholder="Nombre Proveedor" 
                                    className="w-full border p-2 rounded uppercase" 
                                    value={newItem.proveedor} 
                                    onChange={e => setNewItem({...newItem, proveedor: e.target.value.toUpperCase()})} 
                                />
                                <datalist id="suppliers">
                                    {supplierOptions.map(supplier => (
                                        <option key={supplier} value={supplier} />
                                    ))}
                                </datalist>
                            </div>
                            {/* ============================================================= */}

                        </div>
                        <div className="flex gap-2 justify-end">
                            {isEditing && <button onClick={() => { setIsEditing(null); setNewItem({ material: '', color: '', hex: '#000000', calibre: '', estiraje: '', stock: '', proveedor: '', group: '' }); }} className="bg-slate-500 text-white px-4 py-2 rounded font-bold">CANCELAR</button>}
                            <button onClick={handleSave} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded font-bold shadow flex gap-2 items-center">
                                <Icon name="save"/> GUARDAR DATOS
                            </button>
                        </div>
                    </div>

                    {/* LISTA AGRUPADA CON DESPLEGABLES */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="inventory-table w-full text-left border-collapse">
                            <thead className="bg-slate-800 text-white text-sm uppercase">
                                {/* Solo mostramos los encabezados de tabla si AL MENOS UN grupo está en vista de lista */}
                                {Object.keys(groupedItems).some(groupName => (groupViews[groupName] || 'list') === 'list') && (
                                    <tr>
                                        <th className="p-4">Material / Color</th>
                                        <th className="p-4">Detalles Técnicos</th>
                                        <th className="p-4 text-center">Stock (Kg)</th>
                                        <th className="p-4 text-right">Acciones</th>
                                    </tr>
                                )}
                            </thead>
                            <tbody className="text-sm">
                                {Object.keys(groupedItems).length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">No hay hilaturas registradas.</td></tr>}
                                
                                {Object.keys(groupedItems).map(groupName => {
                                    const currentView = groupViews[groupName] || 'list'; // Default a 'list'
                                    
                                    return (
                                        <React.Fragment key={groupName}>
                                            {/* ENCABEZADO DE GRUPO (BOTÓN DESPLEGABLE Y DE VISTA) */}
                                            <tr className="group-header-row">
                                                <td colSpan="4" className="p-0 border-t-2 border-b-2 border-slate-300">
                                                    <div className="w-full flex justify-between items-center p-2 bg-slate-200 hover:bg-slate-300 transition">
                                                        <button 
                                                            onClick={() => toggleGroup(groupName)}
                                                            className="flex items-center gap-2 p-1 font-black text-sm text-indigo-800"
                                                        >
                                                            <Icon name={collapsedGroups[groupName] ? "chevron-right" : "chevron-down"} size={20}/> 
                                                            <span>GRUPO: {groupName} ({groupedItems[groupName].length})</span>
                                                        </button>
                                                        
                                                        {/* BOTONES DE VISTA */}
                                                        <div className="flex gap-1">
                                                            <button 
                                                                onClick={() => toggleGroupView(groupName)}
                                                                className={`p-2 rounded text-xs font-bold transition flex items-center gap-1 ${currentView === 'grid' ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-300'}`}
                                                                title={currentView === 'grid' ? 'Cambiar a Vista de Lista' : 'Cambiar a Vista Mosaico'}
                                                            >
                                                                <Icon name={currentView === 'grid' ? "list" : "grid"} size={16}/> 
                                                                {currentView === 'grid' ? 'Ver Lista' : 'Ver Mosaico'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            
                                            {/* CONTENIDO DEL GRUPO (LISTA O MOSAICO) */}
                                            {!collapsedGroups[groupName] && (
                                                currentView === 'list' ? (
                                                    // VISTA DE LISTA (TABLA)
                                                    groupedItems[groupName].map((item) => {
                                                        const stockFloat = parseFloat(item.stock) || 0;
                                                        const isLow = stockFloat > 0 && stockFloat < 10;
                                                        const isZero = stockFloat === 0;

                                                        return (
                                                            <tr key={item.id} className="border-b hover:bg-slate-50 transition">
                                                                <td className="p-4">
                                                                    <div className="font-bold text-lg text-slate-800">{item.material}</div>
                                                                    <div className="flex flex-col gap-1 mt-2">
                                                                        <div 
                                                                            className="w-full h-8 shadow-sm border border-slate-300 shrink-0" 
                                                                            style={{ backgroundColor: item.hex || '#eee' }}
                                                                            title={`Código HEX: ${item.hex}`}
                                                                        ></div>
                                                                        <div className="flex items-center justify-between">
                                                                            <div className="text-xs text-slate-500 font-bold">{item.color}</div>
                                                                            <div className="text-[10px] text-slate-400 font-mono">{item.hex}</div>
                                                                        </div>
                                                                        <div className="text-[10px] text-slate-400">{item.proveedor}</div>
                                                                    </div>
                                                                </td>
                                                                <td className="p-4">
                                                                    {item.calibre && <div className="text-xs"><span className="font-bold">Calibre:</span> {item.calibre}</div>}
                                                                    {item.estiraje && <div className="text-xs"><span className="font-bold">Estiraje:</span> {item.estiraje}</div>}
                                                                </td>
                                                                <td className="p-4 text-center">
                                                                    <span className={`inline-block px-3 py-1 rounded font-black text-lg 
                                                                        ${isZero ? 'bg-slate-200 text-slate-600' : isLow ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}
                                                                    `}>
                                                                        {isZero ? '0.00' : stockFloat.toFixed(2)} Kg
                                                                    </span>
                                                                    {isZero && <div className="text-[9px] text-slate-500 font-bold mt-1">SIN EXISTENCIA</div>}
                                                                    {isLow && <div className="text-[9px] text-red-500 font-bold mt-1">STOCK BAJO</div>}
                                                                </td>
                                                                <td className="p-4 text-right">
                                                                    <div className="flex gap-2 justify-end">
                                                                        <button onClick={() => startEdit(item)} className="p-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded border border-blue-200" title="Editar detalles"><Icon name="pencil" size={16}/></button>
                                                                        <button onClick={() => handleDelete(item.id)} className="p-2 bg-red-50 text-red-600 hover:bg-red-100 rounded border border-red-200" title="Eliminar"><Icon name="trash-2" size={16}/></button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })
                                                ) : (
                                                    // VISTA DE MOSAICO (GRID)
                                                    <tr>
                                                        <td colSpan="4" className="p-4 bg-slate-50">
                                                            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                                                {groupedItems[groupName].map((item) => (
                                                                    <GridItemCard 
                                                                        key={item.id}
                                                                        item={item}
                                                                        startEdit={startEdit}
                                                                        handleDelete={handleDelete}
                                                                    />
                                                                ))}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )
                                            )}
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InventoryApp />);
    </script>
</body>
</html>
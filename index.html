<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    
    <title>MAES26TV REMOTE</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; color: white; user-select: none; -webkit-tap-highlight-color: transparent; }
        .btn-panel {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 5px 5px 10px #0b1120, -5px -5px 10px #2a3a52;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .btn-panel:active { transform: scale(0.96); box-shadow: inset 5px 5px 10px #0b1120; }
        
        .btn-main {
            background: radial-gradient(circle, #1e293b 0%, #0f172a 100%);
            border: 2px solid rgba(6, 182, 212, 0.2);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.1);
        }
        .btn-main:active { border-color: rgba(6, 182, 212, 0.8); }

        .btn-machine-select {
            background: #0f172a;
            border: 1px solid #334155;
            transition: all 0.2s;
        }
        .btn-machine-select:active {
            background: #0891b2;
            border-color: #22d3ee;
            color: white;
        }

        /* Animaciones del Modal */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen bg-slate-950 overflow-hidden"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const MACHINES = [
            { id: 'm35', name: '35' }, { id: 'm39', name: '39' }, { id: 'm40', name: '40' },
            { id: 'm36', name: '36' }, { id: 'm38', name: '38' }, { id: 'm37', name: '37' },
            { id: 'm29', name: '29' }, { id: 'm28', name: '28' }, { id: 'm27', name: '27' },
            { id: 'm33', name: '33' }, { id: 'm1',  name: '01' }, { id: 'm30', name: '30' },
            { id: 'm31', name: '31' }, { id: 'm6',  name: '06' }, { id: 'm32', name: '32' },
            { id: 'm13', name: '13' }, { id: 'm12', name: '12' }, { id: 'm24', name: '24' },
            { id: 'm8',  name: '08' },
        ];

        // --- COMPONENTE: MODAL DE INSPECCIÓN ---
        const InspectionModal = ({ onClose, onConfirm }) => {
            const [step, setStep] = useState(1); // 1: Fecha, 2: Máquina
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);

            const handleMachineSelect = (machineId) => {
                onConfirm(selectedDate, machineId);
            };

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
                    <div className="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 p-6 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 p-2">
                            <i data-lucide="x" className="w-6 h-6"></i>
                        </button>

                        <h3 className="text-xl font-bold text-white mb-6 text-center">
                            {step === 1 ? 'SELECCIONAR DÍA' : 'SELECCIONAR MÁQUINA'}
                        </h3>

                        {step === 1 && (
                            <div className="flex flex-col gap-6">
                                <input 
                                    type="date" 
                                    value={selectedDate}
                                    onChange={(e) => setSelectedDate(e.target.value)}
                                    className="bg-slate-800 text-white text-2xl p-4 rounded-xl border border-slate-600 text-center w-full"
                                />
                                <button 
                                    onClick={() => setStep(2)}
                                    className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-cyan-900/50 text-lg flex items-center justify-center gap-2"
                                >
                                    CONTINUAR <i data-lucide="arrow-right" className="w-5 h-5"></i>
                                </button>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-4">
                                <div className="text-center text-cyan-400 font-bold mb-2 text-sm border-b border-slate-700 pb-2">
                                    {selectedDate}
                                </div>
                                <div className="grid grid-cols-4 gap-3 max-h-[50vh] overflow-y-auto pr-1">
                                    {MACHINES.map(m => (
                                        <button 
                                            key={m.id}
                                            onClick={() => handleMachineSelect(m.id)}
                                            className="btn-machine-select aspect-square rounded-lg flex flex-col items-center justify-center"
                                        >
                                            <span className="text-[9px] text-slate-500 font-bold">M</span>
                                            <span className="text-lg font-black text-slate-200">{m.name}</span>
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setStep(1)} className="w-full py-3 text-slate-500 text-sm font-bold">
                                    VOLVER
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const RemoteControl = () => {
            const [visibility, setVisibility] = useState({ machines: [] });
            const [navState, setNavState] = useState({ weekDelta: 0, scrollLevel: 0, focus: null });
            const [connected, setConnected] = useState(false);
            const [showInspect, setShowInspect] = useState(false);

            useEffect(() => {
                signInAnonymously(auth).then(() => setConnected(true));
                
                const unsubVis = onSnapshot(doc(db, 'settings', 'visibility'), (s) => {
                    if(s.exists()) setVisibility(s.data());
                });
                
                const unsubNav = onSnapshot(doc(db, 'settings', 'navigation'), (s) => {
                    if(s.exists()) setNavState(s.data());
                    else setDoc(doc(db, 'settings', 'navigation'), { weekDelta: 0, scrollLevel: 0, focus: null });
                });

                return () => { unsubVis(); unsubNav(); };
            }, []);

            // Efecto para recrear iconos cuando cambia el estado
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [showInspect, navState]);

            const updateNav = async (type, delta) => {
                const navRef = doc(db, 'settings', 'navigation');
                const currentNav = navState;
                if (type === 'week') {
                    await updateDoc(navRef, { weekDelta: (currentNav.weekDelta || 0) + delta, scrollLevel: 0 });
                } else if (type === 'scroll') {
                    await updateDoc(navRef, { scrollLevel: Math.max(0, (currentNav.scrollLevel || 0) + delta) });
                } else if (type === 'reset') {
                    await updateDoc(navRef, { weekDelta: 0, scrollLevel: 0, focus: null }); // Reset también quita el detalle
                }
            };

            const toggleMachine = async (id) => {
                const isHidden = visibility.machines?.includes(id);
                let newMachines = [...(visibility.machines || [])];
                isHidden ? newMachines = newMachines.filter(m => m !== id) : newMachines.push(id);
                await updateDoc(doc(db, 'settings', 'visibility'), { machines: newMachines });
            };

            const handleSendInspection = async (date, machineId) => {
                const navRef = doc(db, 'settings', 'navigation');
                // Enviamos el objeto 'focus' que el Monitor detectará para abrir el detalle
                await updateDoc(navRef, { 
                    focus: { 
                        active: true, 
                        date: date, 
                        machineId: machineId 
                    } 
                });
                setShowInspect(false);
            };

            const clearInspection = async () => {
                const navRef = doc(db, 'settings', 'navigation');
                await updateDoc(navRef, { focus: null });
            };

            return (
                <div className="flex flex-col h-full bg-slate-950 p-4 relative">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-2">
                        <div className="flex items-center gap-2">
                            <i data-lucide="tv" className="text-cyan-400"></i>
                            <span className="font-bold text-white tracking-widest">REMOTO</span>
                        </div>
                        <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500 shadow-[0_0_10px_#22c55e]' : 'bg-red-500'}`}></div>
                    </div>

                    {/* GRID DE CONTROL DE NAVEGACIÓN */}
                    <div className="grid grid-cols-3 gap-4 mb-4">
                        
                        {/* COLUMNA IZQUIERDA: SEMANAS */}
                        <div className="flex flex-col gap-3">
                            <div className="text-center text-[10px] text-slate-500 font-bold uppercase">Semanas</div>
                            <button onClick={() => updateNav('week', -1)} 
                                className="btn-panel flex-1 h-14 rounded-xl flex items-center justify-center text-cyan-400">
                                <i data-lucide="chevrons-up" className="w-6 h-6"></i>
                            </button>
                            <button onClick={() => updateNav('week', 1)} 
                                className="btn-panel flex-1 h-14 rounded-xl flex items-center justify-center text-cyan-400">
                                <i data-lucide="chevrons-down" className="w-6 h-6"></i>
                            </button>
                        </div>

                        {/* COLUMNA CENTRAL: RESET / INSPECCIÓN */}
                        <div className="flex flex-col justify-center gap-3">
                            {/* BOTÓN GRANDE DE INSPECCIÓN */}
                            <button onClick={() => setShowInspect(true)}
                                className="btn-panel aspect-square rounded-2xl flex flex-col items-center justify-center border-cyan-500/20 shadow-lg shadow-cyan-900/10">
                                <i data-lucide="calendar-search" className="w-8 h-8 text-cyan-400 mb-1"></i>
                                <span className="text-[9px] text-cyan-100 font-bold">ABRIR<br/>DETALLE</span>
                            </button>
                            
                            <button onClick={() => updateNav('reset', 0)} 
                                className="bg-slate-800 rounded-lg py-2 flex items-center justify-center gap-1 border border-slate-700 active:bg-slate-700">
                                <i data-lucide="rotate-ccw" className="w-3 h-3 text-slate-400"></i>
                                <span className="text-[10px] font-bold text-slate-400">RESET</span>
                            </button>
                        </div>

                        {/* COLUMNA DERECHA: DIAS/SCROLL */}
                        <div className="flex flex-col gap-3">
                            <div className="text-center text-[10px] text-slate-500 font-bold uppercase">Días</div>
                            <button onClick={() => updateNav('scroll', -1)} 
                                className="btn-panel flex-1 h-14 rounded-xl flex items-center justify-center text-cyan-400">
                                <i data-lucide="arrow-up" className="w-6 h-6"></i>
                            </button>
                            <button onClick={() => updateNav('scroll', 1)} 
                                className="btn-panel flex-1 h-14 rounded-xl flex items-center justify-center text-cyan-400">
                                <i data-lucide="arrow-down" className="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>

                    {/* INDICADOR DE DETALLE ACTIVO */}
                    {navState.focus && navState.focus.active && (
                        <div className="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-3 mb-4 flex justify-between items-center animate-pulse">
                            <div>
                                <div className="text-[10px] text-yellow-500 font-bold uppercase">Detalle Abierto</div>
                                <div className="text-xs text-white font-bold">{navState.focus.date} | MAQ {navState.focus.machineId.replace('m','')}</div>
                            </div>
                            <button onClick={clearInspection} className="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold shadow-lg">
                                CERRAR
                            </button>
                        </div>
                    )}

                    {/* Selector de Visibilidad (Más compacto) */}
                    <div className="flex-1 bg-slate-900/50 rounded-2xl p-2 border border-slate-800 overflow-hidden flex flex-col min-h-0">
                        <div className="text-xs font-bold text-slate-500 mb-2 px-2 flex items-center gap-2">
                            <i data-lucide="eye" className="w-3 h-3"></i> VISIBILIDAD TABLA
                        </div>
                        <div className="overflow-auto grid grid-cols-4 gap-2 custom-scrollbar">
                            {MACHINES.map(m => {
                                const isHidden = visibility.machines?.includes(m.id);
                                return (
                                    <button key={m.id} onClick={() => toggleMachine(m.id)}
                                        className={`h-10 rounded-lg font-bold text-xs flex flex-col items-center justify-center transition-all ${
                                            isHidden ? 'bg-slate-800 text-slate-600 opacity-50' : 'bg-cyan-900/40 text-cyan-200 border border-cyan-700/50'
                                        }`}>
                                        <span>{m.name}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* MODAL DE SELECCIÓN */}
                    {showInspect && (
                        <InspectionModal 
                            onClose={() => setShowInspect(false)} 
                            onConfirm={handleSendInspection} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RemoteControl />);
    </script>
</body>
</html>

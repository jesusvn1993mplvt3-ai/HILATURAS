<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo v3.7 (Inventario Integrado)</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @media print {
            body, html, #root { background: white; -webkit-print-color-adjust: exact; width: 100%; height: 100%; margin: 0; padding: 0; }
            .no-print, .dashboard-grid { display: none !important; }
        }
        @media print {
            body:not(.print-mode-ticket) @page { size: letter portrait; margin: 1cm; }
            body:not(.print-mode-ticket) .print-visible-wrapper { display: block !important; width: 100% !important; }
            body:not(.print-mode-ticket) .ticket-container { display: none !important; }
            body:not(.print-mode-ticket) table { border-collapse: collapse; width: 100%; border: 3px solid black; table-layout: fixed; margin-bottom: 8px; }
            body:not(.print-mode-ticket) th { background-color: #d1d5db !important; color: black !important; font-weight: 900 !important; border: 2px solid black !important; }
            body:not(.print-mode-ticket) td { border: 2px solid black !important; padding: 4px !important; font-size: 12pt !important; font-weight: 700 !important; color: black !important; }
            body:not(.print-mode-ticket) .machine-number-val { font-size: 60pt !important; font-weight: 900; line-height: 0.8; }
        }
        @media print {
            body.print-mode-ticket @page { size: 6in 4in landscape; margin: 0; }
            body.print-mode-ticket .print-visible-wrapper { display: none !important; }
            body.print-mode-ticket .ticket-container { display: flex !important; width: 6in; height: 4in; page-break-after: always; padding: 5px; box-sizing: border-box; color: black; }
            .ticket-content { width: 100%; height: 100%; border: 3px solid black; border-radius: 8px; display: flex; flex-direction: column; }
            .ticket-row { display: flex; border-bottom: 2px solid black; }
            .ticket-col { flex: 1; padding: 2px 4px; border-right: 2px solid black; display: flex; flex-direction: column; justify-content: center; }
            .ticket-label { font-size: 8pt; font-weight: bold; text-transform: uppercase; color: #333; }
            .ticket-value { font-size: 12pt; font-weight: 900; text-transform: uppercase; }
            .ticket-value.enormous { font-size: 48pt; color: #dc2626; }
        }
        .dashboard-grid { display: grid; grid-template-rows: 60vh 1fr; height: 100vh; overflow: hidden; }
        .top-pane { overflow-y: auto; border-bottom: 4px solid #334155; }
        .bottom-pane { overflow-x: auto; background: #1e293b; color: white; display: flex; padding: 10px; gap: 10px; }
        .machine-card { min-width: 320px; background: #334155; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; height: 100%; }
        .pkg-list { overflow-y: auto; flex-grow: 1; margin-top: 10px; }
        .obs-input { background: transparent; border: none; color: #cbd5e1; width: 100%; font-size: 10px; border-bottom: 1px solid #475569; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size = 18, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        // --- LÓGICA DE INVENTARIO ---
        const syncWithInventory = async (threading, pieces, isReverting = false) => {
            for (const thread of threading) {
                if (!thread.material || !thread.porcentaje) continue;
                
                // Buscar material en inventario
                const invSnap = await db.collection('inventory').where('material', '==', thread.material).get();
                if (invSnap.empty) continue;

                const invDoc = invSnap.docs[0];
                const invData = invDoc.data();
                
                // Calcular peso total de la orden en KG
                // Peso total = Suma(cantidad_paquetes * peso_pieza_gramos) / 1000
                const pesoTotalOrdenGramos = pieces.reduce((acc, p) => acc + (Number(p.totalPedido) * (Number(p.peso) || 0)), 0);
                const kgConsumidos = (pesoTotalOrdenGramos / 1000) * (parseFloat(thread.porcentaje) / 100);

                const currentStock = Number(invData.cantidad) || 0;
                const newStock = isReverting ? currentStock + kgConsumidos : currentStock - kgConsumidos;

                await db.collection('inventory').doc(invDoc.id).update({
                    cantidad: newStock.toFixed(2),
                    lastUpdate: new Date().toISOString()
                });

                // Bitácora
                await db.collection('inventory').doc(invDoc.id).collection('movimientos').add({
                    fecha: new Date().toISOString(),
                    tipo: isReverting ? 'ENTRADA (DEVOLUCIÓN)' : 'SALIDA (ORDEN)',
                    cantidad: kgConsumidos.toFixed(2),
                    saldo: newStock.toFixed(2),
                    notas: isReverting ? `Orden cancelada sin avance` : `Descuento automático generación de orden`
                });
            }
        };

        const generateSmartID = (partida, pieces, maquina) => {
            const piecePrefixes = pieces.map(p => p.pieza.substring(0, 2).toUpperCase()).join('/');
            return `${partida}-${piecePrefixes}-M${maquina}`;
        };

        const DraftEditor = ({ draft, onSave, onCancel }) => {
            const [localDraft, setLocalDraft] = useState(draft);
            
            const addThread = () => {
                const newThreads = [...(localDraft.threading || []), { guia: (localDraft.threading?.length || 0) + 1, material: '', porcentaje: '' }];
                setLocalDraft({ ...localDraft, threading: newThreads });
            };
            
            const updateThread = (idx, field, val) => {
                const newThreads = [...localDraft.threading];
                newThreads[idx] = { ...newThreads[idx], [field]: val };
                setLocalDraft({ ...localDraft, threading: newThreads });
            };

            const updatePiece = (idx, field, val) => {
                const newPieces = [...localDraft.subPiecesData];
                newPieces[idx] = { ...newPieces[idx], [field]: val };
                setLocalDraft({ ...localDraft, subPiecesData: newPieces });
            };

            return (
                <div className="flex flex-col h-full">
                    <div className="bg-indigo-600 p-4 text-white flex justify-between items-center shrink-0">
                        <h2 className="font-bold text-lg"><Icon name="edit-3" className="inline mr-2"/> Ajuste Final Máquina {localDraft.maquina}</h2>
                    </div>
                    
                    <div className="p-6 overflow-y-auto flex-grow space-y-6">
                        <div className="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded border">
                            <div>
                                <label className="block text-xs font-bold text-gray-500">Máquina</label>
                                <input type="number" value={localDraft.maquina} onChange={e=>setLocalDraft({...localDraft, maquina: e.target.value})} className="w-full border p-1 rounded font-black text-xl"/>
                            </div>
                             <div>
                                <label className="block text-xs font-bold text-gray-500">Partida</label>
                                <input value={localDraft.partida} disabled className="w-full border p-1 rounded bg-gray-200 text-gray-500"/>
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <h3 className="font-bold text-sm text-slate-700">Enhebrado e Inventario</h3>
                                <button onClick={addThread} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200">+ Hilo</button>
                            </div>
                            <table className="w-full text-xs border">
                                <thead className="bg-slate-200">
                                    <tr><th className="p-1">Guía</th><th className="p-1">Material (Debe coincidir con Inv.)</th><th className="p-1">%</th></tr>
                                </thead>
                                <tbody>
                                    {(localDraft.threading || []).map((h, i) => (
                                        <tr key={i}>
                                            <td><input value={h.guia} onChange={e=>updateThread(i,'guia',e.target.value)} className="w-full text-center"/></td>
                                            <td><input value={h.material} onChange={e=>updateThread(i,'material',e.target.value.toUpperCase())} placeholder="EJ: POLIESTER 30/1" className="w-full border p-1 uppercase"/></td>
                                            <td><input value={h.porcentaje} onChange={e=>updateThread(i,'porcentaje',e.target.value)} className="w-full text-center border p-1"/></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div>
                            <h3 className="font-bold text-sm text-slate-700 mb-2">Pesos y Tiempos (Necesario para Inventario)</h3>
                            {localDraft.subPiecesData.map((p, idx) => (
                                <div key={idx} className="bg-white border rounded p-3 mb-2 shadow-sm">
                                    <div className="font-bold text-indigo-700 mb-2 border-b">{p.pieza}</div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div><label className="text-[10px] font-bold">Peso g/pza</label>
                                        <input type="number" value={p.peso} onChange={e=>updatePiece(idx,'peso',e.target.value)} className="w-full border p-1 rounded text-xs bg-yellow-50 font-bold"/></div>
                                        <div><label className="text-[10px] font-bold">Minutos/pza</label>
                                        <input type="number" value={p.tiempo} onChange={e=>updatePiece(idx,'tiempo',e.target.value)} className="w-full border p-1 rounded text-xs"/></div>
                                        <div><label className="text-[10px] font-bold">Talla</label>
                                        <input value={p.talla} onChange={e=>updatePiece(idx,'talla',e.target.value)} className="w-full border p-1 rounded text-xs"/></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="p-4 bg-gray-100 border-t flex justify-end gap-3">
                        <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-bold">Cancelar</button>
                        <button onClick={() => onSave(localDraft)} className="px-6 py-2 rounded bg-green-600 text-white font-bold hover:bg-green-700 shadow flex items-center gap-2">
                            <Icon name="check-circle"/> CREAR Y DESCONTAR INVENTARIO
                        </button>
                    </div>
                </div>
            );
        };

        const OrderGeneratorModal = ({ onClose, onProcess }) => {
            const [step, setStep] = useState('input');
            const [drafts, setDrafts] = useState([]);
            const [currentDraftIndex, setCurrentDraftIndex] = useState(null);

            const [form, setForm] = useState({ modelo: 'M029', cliente: 'MAES', fecha: new Date().toISOString().split('T')[0], partidaCodigo: '', totalPrendas: 250 });
            const [components, setComponents] = useState([{ descripcion: 'DELANTERO', sufijo: 'DEL', maquina: 30, multiplicador: 1, piezasPorPaquete: 25 }]);

            useEffect(() => {
                const d = new Date(form.fecha + 'T00:00:00');
                const meses = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
                setForm(prev => ({ ...prev, partidaCodigo: `${meses[d.getMonth()]}${d.getFullYear().toString().slice(-2)}_01` }));
            }, [form.fecha]);

            const handleGenerateDrafts = () => {
                const ordersByMachine = {};
                components.forEach(comp => {
                    const mk = String(comp.maquina || '0');
                    if (!ordersByMachine[mk]) {
                        ordersByMachine[mk] = {
                            codigo: form.modelo, cliente: form.cliente, maquina: mk, partida: form.partidaCodigo,
                            subPiecesData: [], predefinedPackages: [], createdAt: new Date().toLocaleString('es-MX'),
                            threading: [{ guia: 1, material: '', porcentaje: '' }]
                        };
                    }
                    const totalP = form.totalPrendas * comp.multiplicador;
                    ordersByMachine[mk].subPiecesData.push({ id: Date.now()+Math.random(), pieza: comp.descripcion, talla: 'UNI', totalPedido: totalP, peso: '', tiempo: '' });
                    const numPaq = Math.ceil(totalP / comp.piezasPorPaquete);
                    for (let i = 1; i <= numPaq; i++) {
                        ordersByMachine[mk].predefinedPackages.push({
                            id: Date.now() + Math.random(), piezaNombre: comp.descripcion, 
                            cantidad: (i === numPaq && totalP % comp.piezasPorPaquete !== 0) ? totalP % comp.piezasPorPaquete : comp.piezasPorPaquete,
                            paqueteNum: i, paquetesDePieza: numPaq, codigoUnico: `${form.partidaCodigo}${comp.sufijo}_${i}_${numPaq}`, finished: false
                        });
                    }
                });
                setDrafts(Object.values(ordersByMachine));
                setStep('staging');
            };

            const handleSaveOne = async (finalDraft) => {
                try {
                    const newId = String(Date.now());
                    const displayId = generateSmartID(finalDraft.partida, finalDraft.subPiecesData, finalDraft.maquina);
                    
                    // 1. Sincronizar Inventario (Restar)
                    await syncWithInventory(finalDraft.threading, finalDraft.subPiecesData, false);

                    // 2. Guardar Orden
                    await db.collection('orders').doc(newId).set({
                        ...finalDraft, id: Number(newId), displayId: displayId, progreso: finalDraft.predefinedPackages, status: 'EN PROCESO',
                        totalPedido: finalDraft.subPiecesData.reduce((a,b)=>a+Number(b.totalPedido),0)
                    });

                    const remaining = drafts.filter((_, i) => i !== currentDraftIndex);
                    setDrafts(remaining);
                    setStep('staging');
                    if (remaining.length === 0) onProcess();
                } catch (e) { alert("Error: " + e.message); }
            };

            if (step === 'editing') return <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div className="bg-white rounded-lg w-full max-w-2xl h-[90vh] overflow-hidden"><DraftEditor draft={drafts[currentDraftIndex]} onSave={handleSaveOne} onCancel={() => setStep('staging')} /></div></div>;

            if (step === 'staging') return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg w-full max-w-4xl h-[80vh] flex flex-col">
                        <div className="bg-orange-600 p-4 text-white font-bold">Órdenes en Espera de Confirmación</div>
                        <div className="p-6 grid grid-cols-2 gap-4 overflow-y-auto">
                            {drafts.map((d, i) => (
                                <div key={i} className="border-l-4 border-indigo-500 p-4 bg-slate-50 rounded flex justify-between items-center">
                                    <div><div className="text-xl font-black">MQ {d.maquina}</div><div className="text-xs text-slate-500">{d.subPiecesData.map(p=>p.pieza).join(', ')}</div></div>
                                    <button onClick={()=>{setCurrentDraftIndex(i); setStep('editing');}} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">EDITAR Y CREAR</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg w-full max-w-4xl p-6">
                        <h2 className="text-2xl font-bold mb-4 border-b pb-2">Generador Automático de Órdenes</h2>
                        <div className="grid grid-cols-2 gap-6 mb-6">
                            <div className="space-y-3">
                                <input placeholder="Modelo" value={form.modelo} onChange={e=>setForm({...form, modelo: e.target.value.toUpperCase()})} className="w-full p-2 border rounded font-bold"/>
                                <input type="date" value={form.fecha} onChange={e=>setForm({...form, fecha: e.target.value})} className="w-full p-2 border rounded"/>
                                <input placeholder="Cliente" value={form.cliente} onChange={e=>setForm({...form, cliente: e.target.value.toUpperCase()})} className="w-full p-2 border rounded"/>
                                <input placeholder="Total Prendas" type="number" value={form.totalPrendas} onChange={e=>setForm({...form, totalPrendas: e.target.value})} className="w-full p-2 border rounded bg-yellow-50 font-bold"/>
                            </div>
                            <div className="bg-slate-50 p-3 rounded border overflow-y-auto h-48">
                                <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold">Componentes</span><button onClick={()=>setComponents([...components, {descripcion:'', sufijo:'', maquina:'', multiplicador:1, piezasPorPaquete:25}])} className="text-[10px] bg-green-600 text-white px-2 rounded">+</button></div>
                                {components.map((c, i) => (
                                    <div key={i} className="flex gap-1 mb-1">
                                        <input placeholder="Pieza" value={c.descripcion} onChange={e=>{const n=[...components]; n[i].descripcion=e.target.value.toUpperCase(); setComponents(n)}} className="text-[10px] border p-1 w-full uppercase"/>
                                        <input placeholder="MQ" value={c.maquina} onChange={e=>{const n=[...components]; n[i].maquina=e.target.value; setComponents(n)}} className="text-[10px] border p-1 w-12 text-center"/>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2">Cerrar</button>
                            <button onClick={handleGenerateDrafts} className="bg-blue-600 text-white px-6 py-2 rounded font-bold">GENERAR BORRADORES</button>
                        </div>
                    </div>
                </div>
            );
        };

        const OrderView = ({ order, config, onBack }) => {
            const toggleArchive = async () => {
                const isArchived = order.status === 'ARCHIVADO';
                const avance = Math.round((order.progreso?.filter(p=>p.finished).length / order.progreso?.length)*100) || 0;

                if (!isArchived && avance === 0) {
                    if (window.confirm("Esta orden tiene 0% de avance. ¿Deseas DEVOLVER el material al inventario antes de archivar?")) {
                        await syncWithInventory(order.threading, order.subPiecesData, true);
                    }
                }

                if (window.confirm(isArchived ? "¿Desarchivar?" : "¿Archivar orden?")) {
                    await db.collection('orders').doc(String(order.id)).update({ status: isArchived ? 'EN PROCESO' : 'ARCHIVADO' });
                    onBack();
                }
            };

            const markPkg = async (id, status) => {
                const newP = order.progreso.map(p => p.id === id ? {...p, finished: status, fecha: new Date().toLocaleDateString()} : p);
                await db.collection('orders').doc(String(order.id)).update({ progreso: newP });
            };

            return (
                <div className="bg-white min-h-screen">
                    <div className="no-print p-4 border-b flex justify-between bg-slate-50 sticky top-0 z-50">
                        <button onClick={onBack} className="font-bold flex items-center gap-1"><Icon name="arrow-left"/> Volver</button>
                        <div className="flex gap-2">
                            <button onClick={toggleArchive} className="bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold"><Icon name="archive" size={14} className="inline mr-1"/> {order.status === 'ARCHIVADO' ? 'DESARCHIVAR' : 'ARCHIVAR (REPOSICIÓN SI 0%)'}</button>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-3 py-1 rounded text-xs font-bold"><Icon name="printer" size={14} className="inline mr-1"/> IMPRIMIR</button>
                        </div>
                    </div>
                    <div className="p-8 print:p-0">
                        {/* HEADER CARTA */}
                        <div className="print-visible-wrapper hidden">
                            <div className="flex justify-between border-b-4 border-black pb-2 mb-4">
                                <div><h1 className="text-4xl font-black">{order.cliente}</h1><p className="text-xl">PARTIDA: {order.partida} | MOD: {order.codigo}</p></div>
                                <div className="text-right"><div className="text-xs font-bold">MÁQUINA</div><div className="machine-number-val">{order.maquina}</div></div>
                            </div>
                            <table className="w-full text-sm border-2 border-black mb-4">
                                <thead className="bg-slate-200"><tr><th>PIEZA</th><th>TOTAL</th><th>ENHEBRADO</th></tr></thead>
                                <tbody>
                                    {order.subPiecesData.map((p,i)=>(
                                        <tr key={i}><td>{p.pieza}</td><td className="text-center font-bold">{p.totalPedido}</td>
                                        {i===0 && <td rowSpan={order.subPiecesData.length} className="text-xs p-2">{order.threading?.map(h=>`${h.guia}: ${h.material} (${h.porcentaje}%)`).join(' | ')}</td>}</tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="border-t-2 border-black pt-2">
                                <p className="font-bold text-xs mb-1 uppercase">Control de Paquetes</p>
                                <table className="w-full text-[10px]">
                                    <thead><tr><th className="border">#</th><th className="border">CÓDIGO</th><th className="border">CANT</th><th className="border">FECHA</th><th className="border">TEJEDOR</th></tr></thead>
                                    <tbody>{order.progreso.map((p,i)=><tr key={i}><td className="border text-center">{p.paqueteNum}</td><td className="border px-1">{p.codigoUnico}</td><td className="border text-center font-bold">{p.cantidad}</td><td className="border w-24"></td><td className="border w-32"></td></tr>)}</tbody>
                                </table>
                            </div>
                        </div>

                        {/* REGISTRO DIGITAL */}
                        <div className="no-print space-y-2">
                            <h3 className="font-bold border-b">Control de Avance Digital</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                {order.progreso.map(p=>(
                                    <div key={p.id} className={`p-2 border rounded flex justify-between items-center ${p.finished ? 'bg-green-100 border-green-500' : 'bg-white'}`}>
                                        <div className="text-[10px]"><div className="font-bold">{p.codigoUnico}</div><div>{p.cantidad} pzas</div></div>
                                        <input type="checkbox" checked={p.finished} onChange={e=>markPkg(p.id, e.target.checked)} className="w-5 h-5"/>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [showGenerator, setShowGenerator] = useState(false); 
            const [viewMode, setViewMode] = useState('active'); 
            
            useEffect(() => {
                const u = db.collection('orders').onSnapshot(s => setOrders(s.docs.map(d=>d.data())));
                setTimeout(()=>lucide.createIcons(), 500);
                return () => u();
            }, []);
            useEffect(()=>lucide.createIcons(), [view, orders, viewMode]);

            const grouped = useMemo(() => {
                const filtered = viewMode === 'active' ? orders.filter(o => o.status !== 'ARCHIVADO') : orders.filter(o => o.status === 'ARCHIVADO');
                const groups = {};
                filtered.forEach(o => { if(!groups[o.partida]) groups[o.partida] = []; groups[o.partida].push(o); });
                return Object.entries(groups).sort((a,b)=>b[0].localeCompare(a[0]));
            }, [orders, viewMode]);

            return (
                <div className="h-screen bg-slate-100 overflow-hidden flex flex-col">
                    {showGenerator && <OrderGeneratorModal onClose={()=>setShowGenerator(false)} onProcess={()=>setShowGenerator(false)} />}
                    {view === 'detail' && selectedOrder && <div className="fixed inset-0 z-[100] bg-white overflow-y-auto"><OrderView order={orders.find(o=>o.id===selectedOrder.id) || selectedOrder} onBack={()=>setView('dashboard')}/></div>}

                    <div className="p-4 bg-white border-b flex justify-between items-center shadow-sm">
                        <h1 className="text-xl font-black text-slate-800 flex items-center gap-2">
                            <Icon name="cpu"/> CIRINEO v3.7 <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded">CONECTADO A INVENTARIO</span>
                        </h1>
                        <div className="flex gap-2">
                            <button onClick={()=>setViewMode(viewMode==='active'?'history':'active')} className="text-xs font-bold px-3 py-1 border rounded">{viewMode==='active'?'VER HISTORIAL':'VER PLANTA'}</button>
                            <button onClick={()=>setShowGenerator(true)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold text-xs flex items-center gap-2"><Icon name="plus-circle" size={16}/> GENERAR ORDEN</button>
                        </div>
                    </div>

                    <div className="flex-grow overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        {grouped.map(([partida, items]) => (
                            <div key={partida} className="bg-white rounded-lg shadow border-t-4 border-indigo-600 p-3">
                                <div className="text-xs font-bold text-slate-400 uppercase">Partida</div>
                                <div className="text-lg font-black mb-2">{partida}</div>
                                <div className="space-y-1">
                                    {items.map(o => {
                                        const avance = Math.round((o.progreso?.filter(p=>p.finished).length / o.progreso?.length)*100) || 0;
                                        return (
                                            <div key={o.id} onClick={()=>{setSelectedOrder(o); setView('detail')}} className="p-2 border rounded hover:bg-slate-50 cursor-pointer flex justify-between items-center">
                                                <div className="w-8 h-8 bg-slate-800 text-white rounded flex items-center justify-center font-bold text-xs">{o.maquina}</div>
                                                <div className="flex-grow px-2"><div className="text-[10px] font-bold truncate">{o.codigo}</div><div className="w-full bg-slate-200 h-1 rounded-full"><div className="bg-green-500 h-full" style={{width:`${avance}%`}}></div></div></div>
                                                <div className="text-[10px] font-bold text-green-600">{avance}%</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
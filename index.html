<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Remoto TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { background-color: #1e1e1e; color: white; touch-action: manipulation; }
        .record-btn:active { transform: scale(0.95); background-color: #ef4444; }
        .recording-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const Icon = ({ name, size = 24 }) => <i data-lucide={name} width={size} height={size}></i>;

        const RemoteControl = () => {
            const [note, setNote] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            const [status, setStatus] = useState('Listo');
            const mediaRecorder = useRef(null);
            const audioChunks = useRef([]);

            useEffect(()=>lucide.createIcons(), [status]);

            // --- Enviar Nota de Texto ---
            const sendNote = async () => {
                if(!note.trim()) return;
                setStatus('Enviando...');
                await db.collection('tv_messages').add({
                    type: 'text',
                    content: note.toUpperCase(),
                    timestamp: Date.now()
                });
                setNote('');
                setStatus('Nota Enviada');
                setTimeout(() => setStatus('Listo'), 2000);
            };

            // --- Borrar Nota de TV ---
            const clearNote = async () => {
                await db.collection('tv_messages').add({
                    type: 'text',
                    action: 'clear',
                    content: '',
                    timestamp: Date.now()
                });
                setStatus('Pantalla Limpia');
                setTimeout(() => setStatus('Listo'), 2000);
            };

            // --- Lógica de Grabación de Audio ---
            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder.current = new MediaRecorder(stream);
                    audioChunks.current = [];
                    
                    mediaRecorder.current.ondataavailable = (event) => {
                        audioChunks.current.push(event.data);
                    };

                    mediaRecorder.current.onstop = async () => {
                        const audioBlob = new Blob(audioChunks.current, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = async () => {
                            const base64Audio = reader.result;
                            setStatus('Enviando Audio...');
                            // Guardar en Firestore (nota: limite de 1MB por doc, ok para notas cortas)
                            await db.collection('tv_messages').add({
                                type: 'audio',
                                content: base64Audio,
                                timestamp: Date.now()
                            });
                            setStatus('Audio Enviado');
                            setTimeout(() => setStatus('Listo'), 2000);
                        };
                    };

                    mediaRecorder.current.start();
                    setIsRecording(true);
                } catch (err) {
                    alert("Error accediendo al micrófono: " + err);
                }
            };

            const stopRecording = () => {
                if (mediaRecorder.current && isRecording) {
                    mediaRecorder.current.stop();
                    setIsRecording(false);
                }
            };

            return (
                <div className="flex flex-col h-screen p-4 max-w-md mx-auto">
                    <h1 className="text-xl font-bold text-center mb-6 text-slate-400">CONTROL CIRINEO TV</h1>
                    
                    <div className="bg-slate-800 p-4 rounded-lg shadow-lg mb-6">
                        <label className="text-xs font-bold text-slate-400 mb-2 block">ENVIAR NOTA A PANTALLA</label>
                        <textarea 
                            value={note}
                            onChange={(e) => setNote(e.target.value)}
                            className="w-full bg-slate-900 text-white p-3 rounded border border-slate-600 mb-3 text-lg font-bold uppercase"
                            rows="3"
                            placeholder="ESCRIBE AQUÍ..."
                        ></textarea>
                        <div className="flex gap-2">
                            <button onClick={clearNote} className="flex-1 bg-red-900 text-red-200 py-3 rounded font-bold text-sm">QUITAR NOTA</button>
                            <button onClick={sendNote} className="flex-1 bg-blue-600 text-white py-3 rounded font-bold shadow-lg active:bg-blue-700">ENVIAR TEXTO</button>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center bg-slate-800 rounded-lg shadow-lg p-6">
                        <div className="text-xs font-bold text-slate-400 mb-8">MANTÉN PRESIONADO PARA GRABAR</div>
                        
                        <button 
                            onMouseDown={startRecording}
                            onMouseUp={stopRecording}
                            onTouchStart={startRecording}
                            onTouchEnd={stopRecording}
                            className={`w-32 h-32 rounded-full flex items-center justify-center shadow-2xl transition-all record-btn ${isRecording ? 'bg-red-500 recording-pulse' : 'bg-slate-700'}`}
                        >
                            <Icon name="mic" size={48} className="text-white"/>
                        </button>
                        
                        <div className={`mt-6 font-bold text-lg ${isRecording ? 'text-red-500' : 'text-slate-500'}`}>
                            {isRecording ? 'GRABANDO...' : status}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RemoteControl />);
    </script>
</body>
</html>

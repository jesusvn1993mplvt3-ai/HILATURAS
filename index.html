<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MAES26TV">
    <meta name="theme-color" content="#0f172a">
    
    <link id="manifest-link" rel="manifest" href="">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Doc/refs/heads/main/icon-maes26.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Doc/refs/heads/main/icon-maes26.png">

    <title>MAES26TV</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            background-color: #020617; 
            color: white; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            font-family: system-ui, -apple-system, sans-serif;
            overscroll-behavior: none;
        }
        
        /* Efecto de fondo tecnológico */
        .tech-bg {
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 50%),
                linear-gradient(0deg, rgba(15, 23, 42, 1) 0%, rgba(2, 6, 23, 1) 100%);
        }

        /* Botones estilo cristal/neón */
        .btn-control {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 5px 5px 10px #0b1120, -5px -5px 10px #2a3a52;
            transition: all 0.15s ease;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .btn-control:active {
            box-shadow: inset 5px 5px 10px #0b1120, inset -5px -5px 10px #2a3a52;
            transform: scale(0.98);
        }
        
        /* Botón de RESET central */
        .btn-center {
            background: radial-gradient(circle, #1e293b 0%, #0f172a 100%);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.1);
            border: 2px solid rgba(6, 182, 212, 0.2);
        }
        .btn-center:active {
            border-color: rgba(6, 182, 212, 0.8);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
        }

        /* Scrollbar oculto pero funcional */
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        .glow-text { text-shadow: 0 0 10px rgba(6, 182, 212, 0.5); }

        /* Animación para el modal de instalación */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .install-modal {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen flex flex-col tech-bg"></div>

    <script>
        // 1. Generar Manifest dinámico con el icono solicitado y nombre actualizado
        const iconUrl = "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Doc/refs/heads/main/icon-maes26.png";
        const manifest = {
            "name": "MAES26TV",
            "short_name": "MAES26TV",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#020617",
            "theme_color": "#0f172a",
            "orientation": "portrait",
            "icons": [
                {
                    "src": iconUrl,
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": iconUrl,
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-link').setAttribute('href', manifestURL);

        // 2. Registrar Service Worker Dummy (Requisito para PWA en Android)
        if ('serviceWorker' in navigator) {
            const swContent = `
                self.addEventListener('install', (e) => e.waitUntil(self.skipWaiting()));
                self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
                self.addEventListener('fetch', (e) => {});
            `;
            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl)
                .then(() => console.log('SW Registrado'))
                .catch(err => console.error('SW Error', err));
        }
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const MACHINES = [
            { id: 'm35', name: '35' }, { id: 'm39', name: '39' }, { id: 'm40', name: '40' },
            { id: 'm36', name: '36' }, { id: 'm38', name: '38' }, { id: 'm37', name: '37' },
            { id: 'm29', name: '29' }, { id: 'm28', name: '28' }, { id: 'm27', name: '27' },
            { id: 'm33', name: '33' }, { id: 'm1',  name: '01' }, { id: 'm30', name: '30' },
            { id: 'm31', name: '31' }, { id: 'm6',  name: '06' }, { id: 'm32', name: '32' },
            { id: 'm13', name: '13' }, { id: 'm12', name: '12' }, { id: 'm24', name: '24' },
            { id: 'm8',  name: '08' },
        ];

        // Componente Modal de Instalación
        const InstallPrompt = ({ installEvent, onDismiss }) => {
            if (!installEvent) return null;

            const handleInstall = () => {
                installEvent.prompt();
                installEvent.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        onDismiss();
                    }
                });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="install-modal bg-slate-900 border border-cyan-500/30 w-full max-w-sm rounded-2xl p-6 shadow-[0_0_50px_rgba(6,182,212,0.2)] flex flex-col items-center text-center">
                        <img 
                            src="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Doc/refs/heads/main/icon-maes26.png" 
                            className="w-20 h-20 rounded-2xl mb-4 shadow-lg"
                        />
                        <h3 className="text-xl font-bold text-white mb-2">Instalar App MAES26TV</h3>
                        <p className="text-slate-400 text-sm mb-6">
                            Para un mejor control y pantalla completa, instala la aplicación en tu dispositivo.
                        </p>
                        <div className="flex gap-3 w-full">
                            <button 
                                onClick={onDismiss}
                                className="flex-1 py-3 rounded-xl font-bold text-slate-400 bg-slate-800"
                            >
                                Ahora no
                            </button>
                            <button 
                                onClick={handleInstall}
                                className="flex-1 py-3 rounded-xl font-bold text-slate-900 bg-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.5)] animate-pulse"
                            >
                                INSTALAR
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const RemoteControl = () => {
            const [visibility, setVisibility] = useState({ machines: [] });
            // Usamos 'weekDelta' para reflejar el cambio de semana desde el inicio, y 'scrollLevel' para el scroll vertical (días).
            const [navState, setNavState] = useState({ weekDelta: 0, scrollLevel: 0 }); 
            const [connected, setConnected] = useState(false);
            
            // Estado para la instalación PWA
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showInstallModal, setShowInstallModal] = useState(false);

            useEffect(() => {
                // Lógica de PWA Install Prompt
                const handler = (e) => {
                    e.preventDefault(); 
                    setDeferredPrompt(e);
                    setShowInstallModal(true);
                };
                window.addEventListener('beforeinstallprompt', handler);

                // Firebase Auth
                signInAnonymously(auth).then(() => setConnected(true));
                
                // Listeners
                const unsubVis = onSnapshot(doc(db, 'settings', 'visibility'), (s) => {
                    if(s.exists()) setVisibility(s.data());
                });
                const unsubNav = onSnapshot(doc(db, 'settings', 'navigation'), (s) => {
                    // Esperamos que el documento contenga weekDelta y scrollLevel
                    if(s.exists()) setNavState(s.data());
                    else setDoc(doc(db, 'settings', 'navigation'), { weekDelta: 0, scrollLevel: 0 });
                });
                
                return () => { 
                    unsubVis(); unsubNav(); 
                    window.removeEventListener('beforeinstallprompt', handler);
                };
            }, []);

            const updateNav = async (type, delta) => {
                const navRef = doc(db, 'settings', 'navigation');
                const currentNav = navState;

                if (type === 'week') {
                    // Mover entre semanas: actualiza weekDelta y resetea scroll
                    await updateDoc(navRef, { 
                        weekDelta: (currentNav.weekDelta || 0) + delta,
                        scrollLevel: 0
                    });
                } else if (type === 'scroll') {
                    // Mover entre días: actualiza scrollLevel, asegurando que no sea negativo
                    await updateDoc(navRef, { 
                        scrollLevel: Math.max(0, (currentNav.scrollLevel || 0) + delta)
                    });
                } else if (type === 'reset') {
                    // Reset a la semana actual y sin scroll
                    await updateDoc(navRef, { 
                        weekDelta: 0,
                        scrollLevel: 0
                    });
                }
            };

            const toggleMachine = async (id) => {
                const isHidden = visibility.machines?.includes(id);
                let newMachines = [...(visibility.machines || [])];
                isHidden ? newMachines = newMachines.filter(m => m !== id) : newMachines.push(id);
                await updateDoc(doc(db, 'settings', 'visibility'), { machines: newMachines });
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden relative">
                    
                    {/* MODAL DE INSTALACIÓN */}
                    {showInstallModal && (
                        <InstallPrompt 
                            installEvent={deferredPrompt} 
                            onDismiss={() => setShowInstallModal(false)} 
                        />
                    )}

                    {/* --- HEADER --- */}
                    <div className="p-4 flex justify-between items-center z-10 bg-slate-900/50 backdrop-blur-md border-b border-white/10">
                        <div className="flex items-center gap-3">
                            <img src="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Doc/refs/heads/main/icon-maes26.png" 
                                className="w-10 h-10 rounded-lg shadow-[0_0_15px_rgba(6,182,212,0.3)] border border-cyan-500/30" />
                            <div>
                                <h1 className="text-lg font-black text-white tracking-widest leading-none">MAES26TV</h1>
                                <span className="text-[10px] text-cyan-400 font-bold uppercase tracking-[0.2em] glow-text">Control Remoto</span>
                            </div>
                        </div>
                        <div className="flex flex-col items-end">
                            <div className={`w-2 h-2 rounded-full mb-1 ${connected ? 'bg-green-400 shadow-[0_0_8px_#4ade80]' : 'bg-red-500 animate-pulse'}`}></div>
                            <span className="text-[8px] text-slate-500 uppercase font-bold">{connected ? 'ONLINE' : 'OFFLINE'}</span>
                        </div>
                    </div>

                    {/* --- CONTROLES DE NAVEGACIÓN D-PAD --- */}
                    <div className="flex-1 flex flex-col justify-center items-center relative py-6">
                        
                        {/* Decoración de fondo */}
                        <div className="absolute inset-0 pointer-events-none flex justify-center items-center opacity-10">
                            <div className="w-64 h-64 border border-cyan-500 rounded-full border-dashed animate-[spin_10s_linear_infinite]"></div>
                            <div className="absolute w-48 h-48 border border-slate-500 rounded-full animate-[spin_15s_linear_infinite_reverse]"></div>
                        </div>

                        {/* Botonera D-Pad */}
                        <div className="grid grid-cols-3 gap-2 z-10 w-full max-w-[280px]">

                            {/* Fila 1: Semana Anterior (UP) */}
                            <div className="col-start-2 flex flex-col items-center">
                                <button onClick={() => updateNav('week', -1)} 
                                    className="btn-control w-full h-16 rounded-xl flex items-center justify-center text-cyan-400 active:text-white group">
                                    <i data-lucide="chevrons-up" className="w-8 h-8 transition-transform group-active:-translate-y-1"></i>
                                </button>
                                <span className="text-[10px] text-slate-500 font-bold uppercase block text-center mt-1">SEMANA ANT.</span>
                            </div>
                            
                            {/* Fila 2: Scroll Izquierda (Día Anterior) | Reset/Display | Scroll Derecha (Día Siguiente) */}
                            <div className="flex flex-col items-center">
                                <button onClick={() => updateNav('scroll', -1)} 
                                    className="btn-control w-full h-16 rounded-xl flex items-center justify-center text-cyan-400 active:text-white group">
                                    <i data-lucide="chevron-left" className="w-8 h-8 transition-transform group-active:-translate-x-1"></i>
                                </button>
                                <span className="text-[10px] text-slate-500 font-bold uppercase block text-center mt-1">DÍA ANT.</span>
                            </div>
                            
                            {/* RESET / DISPLAY CENTRAL */}
                            <button onClick={() => updateNav('reset', 0)} 
                                className="btn-center w-full h-24 rounded-xl flex flex-col items-center justify-center relative overflow-hidden group">
                                <span className="text-[10px] text-slate-400 uppercase font-bold tracking-widest leading-tight">SEMANA</span>
                                <span className="text-3xl font-black text-white glow-text leading-none">
                                    {navState.weekDelta > 0 ? `+${navState.weekDelta}` : navState.weekDelta}
                                </span>
                                <div className="mt-1 px-2 py-0.5 bg-cyan-900/50 rounded text-[9px] text-cyan-300 font-bold border border-cyan-500/30">
                                    RESET HOY
                                </div>
                            </button>
                            
                            <div className="flex flex-col items-center">
                                <button onClick={() => updateNav('scroll', 1)} 
                                    className="btn-control w-full h-16 rounded-xl flex items-center justify-center text-cyan-400 active:text-white group">
                                    <i data-lucide="chevron-right" className="w-8 h-8 transition-transform group-active:translate-x-1"></i>
                                </button>
                                <span className="text-[10px] text-slate-500 font-bold uppercase block text-center mt-1">DÍA SIG.</span>
                            </div>

                            {/* Fila 3: Semana Siguiente (DOWN) */}
                            <div className="col-start-2 flex flex-col items-center">
                                <span className="text-[10px] text-slate-400 uppercase font-bold block text-center mb-1">SCROLL DÍA: <span className="text-cyan-400">{navState.scrollLevel}</span></span>
                                <button onClick={() => updateNav('week', 1)} 
                                    className="btn-control w-full h-16 rounded-xl flex items-center justify-center text-cyan-400 active:text-white group">
                                    <i data-lucide="chevrons-down" className="w-8 h-8 transition-transform group-active:translate-y-1"></i>
                                </button>
                                <span className="text-[10px] text-slate-500 font-bold uppercase block text-center mt-1">SEMANA SIG.</span>
                            </div>
                        </div>
                        
                        {/* Instrucción adicional sobre el Reporte de Celda */}
                        <div className="mt-8 text-center px-4">
                            <p className="text-slate-600 text-xs font-bold uppercase tracking-widest border-t border-slate-800 pt-4">
                                El **Reporte Detallado** (abrir/cerrar) se maneja con un **toque directo en la celda** del monitor.
                            </p>
                        </div>
                    </div>

                    {/* --- SELECTOR DE MÁQUINAS --- */}
                    <div className="bg-slate-900/80 backdrop-blur-xl rounded-t-[2.5rem] border-t border-white/5 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] flex flex-col max-h-[45vh]">
                        
                        <div className="p-5 pb-2 flex justify-between items-end border-b border-white/5 mx-4">
                            <div>
                                <h2 className="text-sm font-bold text-slate-300 uppercase tracking-wider">Visibilidad</h2>
                                <p className="text-[10px] text-slate-500">Toca para ocultar/mostrar</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <i data-lucide="monitor" className="w-4 h-4 text-cyan-500"></i>
                                <span className="font-mono font-bold text-cyan-400">
                                    {MACHINES.length - (visibility.machines?.length || 0)}<span className="text-slate-600">/{MACHINES.length}</span>
                                </span>
                            </div>
                        </div>

                        <div className="overflow-auto p-4 pb-8 hide-scroll grid grid-cols-4 gap-3">
                            {MACHINES.map(m => {
                                const isHidden = visibility.machines?.includes(m.id);
                                return (
                                    <button 
                                        key={m.id}
                                        onClick={() => toggleMachine(m.id)}
                                        className={`
                                            relative h-14 rounded-xl font-bold text-sm transition-all duration-200 flex flex-col items-center justify-center
                                            ${isHidden 
                                                ? 'bg-slate-800/50 text-slate-600 border border-slate-700/50 grayscale opacity-60' 
                                                : 'bg-gradient-to-br from-cyan-600 to-blue-700 text-white border border-cyan-400/50 shadow-[0_0_15px_rgba(6,182,212,0.3)]'
                                            }
                                        `}
                                    >
                                        <span className="text-[10px] opacity-70 uppercase tracking-wider">MAQ</span>
                                        <span className="text-lg leading-none">{m.name}</span>
                                        {!isHidden && <div className="absolute top-1 right-1 w-1.5 h-1.5 bg-white rounded-full shadow-[0_0_5px_white]"></div>}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RemoteControl />);
        lucide.createIcons();
    </script>
</body>
</html>